import { Stagehand } from "@browserbasehq/stagehand";
import { execSync } from "child_process";

function getOfficeAuth() {
  try {
    const output = execSync("python fetch_token.py").toString();
    return JSON.parse(output);
  } catch (error) {
    console.error("Error fetching token.");
    process.exit(1);
  }
}

async function runLinkedInTask() {
  const auth = getOfficeAuth();

  // We define the model using Stagehand's native configuration
  // This avoids the "doGenerate" and "v3/v2" version mismatch errors
  const stagehand = new Stagehand({
    env: "LOCAL",
    verbose: 2,
    modelName: "us.anthropic.claude-sonnet-4-5-20250929-v1:0", // Your specific model ID
    modelConfig: {
      endpoint: auth.baseurl,
      apiKey: auth.token, // Stagehand will use this for the Authorization header
    },
    browserArgs: ["--no-sandbox", "--disable-gpu"]
  });

  console.log("Initializing Stagehand...");
  await stagehand.init();
  
  // Use context.pages()[0] as per v3 documentation
  let page = stagehand.context.pages()[0];
  if (!page) {
    page = await stagehand.context.newPage();
  }

  try {
    console.log("Navigating to LinkedIn...");
    await page.goto("https://www.linkedin.com", { waitUntil: "domcontentloaded" });
    
    // Give office security scripts time to settle
    await new Promise(r => setTimeout(r, 4000));

    console.log("Executing actions...");
    await stagehand.act("Click the 'Join now' button");
    await stagehand.act("Click the 'Continue with Google' button");
    await stagehand.act("Type %name% into the email field", {
      variables: { name: "Sandeep" }
    });

    console.log("Process complete!");
  } catch (err: any) {
    console.error("Automation Error:", err.message);
  } finally {
    await stagehand.close();
  }
}

runLinkedInTask();
