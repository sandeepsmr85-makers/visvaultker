import { Stagehand, AISdkClient } from "@browserbasehq/stagehand";
import { createOpenAI } from "@ai-sdk/openai";
import { execSync } from "child_process";

/**
 * Fetches credentials from your local office Python script.
 */
function getOfficeAuth() {
  try {
    const output = execSync("python fetch_token.py").toString();
    return JSON.parse(output);
  } catch (error) {
    console.error("Error: Could not execute fetch_token.py or parse JSON output.");
    process.exit(1);
  }
}

async function runLinkedInTask() {
  const auth = getOfficeAuth();

  // 1. Setup the Internal Model (Claude Sonnet 3.5/4)
  const officeModel = createOpenAI({
    baseURL: auth.baseurl,
    apiKey: "OFFICE_TOKEN_USED", 
    headers: {
      Authorization: `Bearer ${auth.token}`,
    },
  })("us.anthropic.claude-sonnet-4-5-20250929-v1:0");

  // 2. Initialize Stagehand with Local Environment
  const stagehand = new Stagehand({
    env: "LOCAL", 
    verbose: 2, // Keeps you informed on what the LLM is thinking
    llmClient: new AISdkClient({
      model: officeModel as any,
    }),
  });

  console.log("Initializing Stagehand...");
  await stagehand.init();
  
  // 3. Robust Page Selection (Fixes the about:blank / undefined error)
  let page = stagehand.page;

  if (!page) {
    console.log("Default page not found, attempting to capture active tab...");
    const pages = stagehand.context.pages();
    if (pages.length > 0) {
      page = pages[0];
    } else {
      console.log("No pages found. Creating a new browser tab...");
      page = await stagehand.context.newPage();
    }
  }

  // Final check to ensure we have a valid page object
  if (!page) {
    throw new Error("Could not initialize a browser page. Check Chromium permissions.");
  }

  try {
    console.log("Navigating to LinkedIn...");
    // waitUntil: 'domcontentloaded' helps in restrictive office networks
    await page.goto("https://www.linkedin.com", { waitUntil: "domcontentloaded" });

    console.log("Step 1: Clicking Join Now...");
    await stagehand.act("Click on the 'Join now' button");

    console.log("Step 2: Choosing Google Login...");
    await stagehand.act("Click the 'Continue with Google' button");

    console.log("Step 3: Entering Username...");
    // Using %name% ensures the browser driver handles the typing for privacy
    await stagehand.act("Type %name% into the email or phone field", {
      variables: {
        name: "Sandeep"
      }
    });

    console.log("Automation task finished successfully.");
  } catch (err) {
    console.error("The automation failed during execution:");
    console.error(err);
  } finally {
    console.log("Closing browser...");
    await stagehand.close();
  }
}

// Start the automation
runLinkedInTask().catch((err) => {
  console.error("Fatal Error:", err);
  process.exit(1);
});
