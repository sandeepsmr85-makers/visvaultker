import * as dotenv from "dotenv";
dotenv.config();

import { Stagehand } from "@browserbasehq/stagehand";
import { execFile } from "child_process";
import { promisify } from "util";

const execFileAsync = promisify(execFile);

const PYTHON_PATH = process.env.PYTHON_PATH || "python";
const OAUTH_SCRIPT = process.env.OAUTH_SCRIPT || "fetch_token.py";
const GATEWAY_MODEL_ID = process.env.GATEWAY_MODEL_ID || "gpt-4.1-2025-04-14-eastus-dz";

async function getTokenAndUrl(): Promise<{ access_token: string; baseURL: string }> {
  const { stdout } = await execFileAsync(PYTHON_PATH, [OAUTH_SCRIPT]);
  const data = JSON.parse(stdout.trim());
  if (data.error || !data.access_token || !data.baseURL) {
    throw new Error("OAuth script error");
  }
  return data;
}

async function main() {
  process.env.NODE_TLS_REJECT_UNAUTHORIZED = "0";

  const { access_token, baseURL } = await getTokenAndUrl();
  const chatUrl = baseURL.endsWith("/v1") ? baseURL : baseURL.replace(/\/$/, "") + "/v1";

  // Custom fetch to swap model name for gateway
  const customFetch: typeof fetch = async (url, options) => {
    if (options?.body) {
      try {
        const bodyStr = typeof options.body === "string" ? options.body : JSON.stringify(options.body);
        const body = JSON.parse(bodyStr);
        
        // Swap to your gateway model ID
        if (body.model) {
          body.model = GATEWAY_MODEL_ID;
        }
        
        const newBody = JSON.stringify(body);
        const headers = new Headers(options.headers);
        headers.set("Content-Length", String(Buffer.byteLength(newBody, "utf8")));
        
        options = {
          ...options,
          body: newBody,
          headers: headers,
        };
      } catch (e) {
        // Not JSON, ignore
      }
    }
    
    return fetch(url, options);
  };

  const stagehand = new Stagehand({
    env: "LOCAL",
    model: {
      modelName: "gpt-4o",  // Stagehand validation
      apiKey: access_token,
      baseURL: chatUrl,
      fetch: customFetch,   // Swap to gateway model
    },
    verbose: 1,
    selfHeal: true,
  });

  await stagehand.init();

  const page = stagehand.context.pages()[0];
  if (!page) {
    throw new Error("No page found in Stagehand context");
  }

  try {
    await page.goto("https://rbcga.ea.rbc.us-east-1.aws.smarsh.cloud/portola/login");
    console.log("✓ Testing login flow...");

    await stagehand.act("enter text john.smith@rbc.com into the username field");
    await stagehand.act("enter text Pa$$word123 into the password field");
    await stagehand.act("click LOGIN");

    await page.waitForLoadState("networkidle", { timeout: 30000 });
    console.log("✓ Login page navigation completed.");

    console.log("✓ Should trigger the next job switch scenario");
    await stagehand.act("click app switcher");

    console.log("✓ Successfully clicked App Switch");
  } catch (error) {
    console.error("✗ Error:", error.message);
    throw error;
  } finally {
    await stagehand.close();
  }
}

main().catch((error) => {
  console.error("✗ Error:", error.message);
  process.exit(1);
});
